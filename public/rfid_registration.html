<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RFID Registration Form - RSU</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <!-- Add date picker library -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Add input mask library -->
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5/dist/inputmask.min.js"></script>
</head>
<body>
  <div class="page-header">
    <h1>RFID Registration Form</h1>
    <p>Romblon State University - Main Campus</p>
  </div>

  <div class="form-container">
    <form id="rfidForm">
      <h2 class="form-title">Register Your RFID ID</h2>

      <!-- RFID Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-id-card"></i>
          RFID Identification
        </div>
        
        <div class="form-group">
          <label for="rfid" class="form-label">RFID Number</label>
          <div class="input-icon">
            <i class="fas fa-credit-card"></i>
            <input type="text" id="rfid" class="form-control rfid-field" placeholder="Tap your RFID card here" readonly>
          </div>
          <div class="rfid-status status-waiting">
            <i class="fas fa-sync-alt fa-spin"></i>
            Waiting for RFID card...
          </div>
        </div>

        <div class="form-group">
          <label for="role" class="form-label">Role</label>
          <div class="input-icon">
            <i class="fas fa-user-tag"></i>
            <select id="role" class="form-control" required onchange="toggleDepartmentField()">
              <option value="">Select Your Role</option>
              <option value="student">Student</option>
              <option value="employee">Employee</option>
              <option value="faculty">Faculty</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Photo Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-camera"></i>
          Profile Photo
        </div>
        
        <div class="camera-section">
          <button type="button" id="open-camera-btn" class="btn btn-accent">
            <i class="fas fa-camera"></i>
            Open Camera
          </button>

          <div id="live-area" style="display:none;">
            <video id="camera" autoplay playsinline muted></video>
            <button type="button" id="capture-btn" class="btn btn-primary">
              <i class="fas fa-camera-retro"></i>
              Capture Photo
            </button>
          </div>

          <img id="photo-preview" class="camera-preview" alt="Captured Image" style="display:none;">
          <button type="button" id="retake-btn" class="btn btn-secondary" style="display:none; margin-top:15px;">
            <i class="fas fa-redo"></i>
            Retake Photo
          </button>
        </div>
        <input type="hidden" name="photoData" id="photoData">
      </div>

      <!-- Personal Information -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-user"></i>
          Personal Information
        </div>

        <div class="form-group">
          <label class="form-label">Full Name</label>
          <div class="form-row">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="First Name" id="firstName" required>
              <div class="validation-message" id="firstNameValidation"></div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" placeholder="M.I." id="middleInitial" maxlength="2">
              <div class="validation-message" id="middleInitialValidation"></div>
            </div>
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Last Name" id="lastName" required>
              <div class="validation-message" id="lastNameValidation"></div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="department" class="form-label">College / Department</label>
            <div class="input-icon">
              <i class="fas fa-building"></i>
              <div id="departmentContainer">
                <!-- Dynamic field - will be populated by JavaScript -->
                <input type="text" class="form-control" placeholder="College or Department" id="department" required>
              </div>
            </div>
            <div class="validation-message" id="departmentValidation"></div>
          </div>
          <div class="form-group">
            <label for="coursePosition" class="form-label">Course / Position</label>
            <div class="input-icon">
              <i class="fas fa-briefcase"></i>
              <div id="coursePositionContainer">
                <!-- Dynamic field - will be populated by JavaScript -->
                <input type="text" class="form-control" placeholder="Course or Position" id="coursePosition" required>
              </div>
            </div>
            <div class="validation-message" id="coursePositionValidation"></div>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-address-card"></i>
          Contact Information
        </div>

        <div class="form-group">
          <label for="address" class="form-label">Address</label>
          <div class="input-icon">
            <i class="fas fa-home"></i>
            <input type="text" class="form-control" placeholder="Complete Address" id="address" required>
          </div>
          <div class="validation-message" id="addressValidation"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contactNumber" class="form-label">Contact Number</label>
            <div class="input-icon">
              <i class="fas fa-phone"></i>
              <input type="text" class="form-control" placeholder="+63 912 345 6789" id="contactNumber" required>
            </div>
            <div class="validation-message" id="contactNumberValidation"></div>
          </div>
          <div class="form-group">
            <label for="birthdate" class="form-label">Birthdate</label>
            <div class="input-icon">
              <i class="fas fa-birthday-cake"></i>
              <input type="text" class="form-control" placeholder="Select Date" id="birthdate" required>
            </div>
            <div class="validation-message" id="birthdateValidation"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="height" class="form-label">Height (cm)</label>
            <div class="input-icon">
              <i class="fas fa-ruler-vertical"></i>
              <input type="number" class="form-control" placeholder="Height in cm" id="height" min="100" max="250" step="0.1">
            </div>
            <div class="validation-message" id="heightValidation"></div>
          </div>
          <div class="form-group">
            <label for="weight" class="form-label">Weight (kg)</label>
            <div class="input-icon">
              <i class="fas fa-weight"></i>
              <input type="number" class="form-control" placeholder="Weight in kg" id="weight" min="30" max="200" step="0.1">
            </div>
            <div class="validation-message" id="weightValidation"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="gender" class="form-label">Gender</label>
            <div class="input-icon">
              <i class="fas fa-venus-mars"></i>
              <select class="form-control" id="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
              </select>
            </div>
            <div class="validation-message" id="genderValidation"></div>
          </div>
          <div class="form-group">
            <label for="civilStatus" class="form-label">Civil Status</label>
            <div class="input-icon">
              <i class="fas fa-heart"></i>
              <select class="form-control" id="civilStatus" required>
                <option value="">Select Civil Status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
                <option value="Separated">Separated</option>
              </select>
            </div>
            <div class="validation-message" id="civilStatusValidation"></div>
          </div>
        </div>
      </div>

      <!-- Emergency Contact -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-first-aid"></i>
          Emergency Contact
        </div>

        <div class="form-group">
          <label for="emergencyContact" class="form-label">Emergency Contact Person</label>
          <div class="input-icon">
            <i class="fas fa-user-friends"></i>
            <input type="text" class="form-control" placeholder="Name of Emergency Contact" id="emergencyContact" required>
          </div>
          <div class="validation-message" id="emergencyContactValidation"></div>
        </div>

        <div class="form-group">
          <label for="emergencyAddress" class="form-label">Emergency Contact Address</label>
          <div class="input-icon">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" class="form-control" placeholder="Address of Emergency Contact" id="emergencyAddress" required>
          </div>
          <div class="validation-message" id="emergencyAddressValidation"></div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="btn-group">
        <button type="button" id="preview-btn" class="btn btn-accent">
          <i class="fas fa-eye"></i>
          Preview ID
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i>
          Submit Registration
        </button>
      </div>
    </form>
  </div>

  <!-- Modals -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ID Preview</h3>
        <button class="modal-close" id="closePreview" aria-label="Close preview">&times;</button>
      </div>
      <div id="idPreviewContainer" class="flex-center"></div>
      <div class="btn-group mt-2">
        <button id="closePreview" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <div id="cameraModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:540px; width:92%;">
      <div class="modal-header">
        <h3 class="modal-title">Take Profile Photo</h3>
        <button class="modal-close" id="modalClose" aria-label="Close camera">&times;</button>
      </div>
      <div style="position:relative;">
        <video id="modalVideo" autoplay playsinline muted style="width:100%; background:#000; border-radius:8px;"></video>
        <canvas id="modalSnapshot" style="display:none;"></canvas>
      </div>
      <div style="display:flex; gap:12px; margin-top:20px; justify-content:flex-end;">
        <button id="modalClose" class="btn btn-secondary" type="button">Close</button>
        <button id="modalCapture" class="btn btn-primary" type="button">
          <i class="fas fa-camera"></i>
          Capture Photo
        </button>
      </div>
    </div>
  </div>

  <div id="cropModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:680px; width:95%;">
      <div class="modal-header">
        <h3 class="modal-title">Crop Profile Photo</h3>
        <button class="modal-close" id="cropCancel" aria-label="Close crop modal">&times;</button>
      </div>
      <canvas id="cropCanvas" style="width:100%; border-radius:8px; background:#000;"></canvas>
      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
        <button id="cropCancel" class="btn btn-secondary" type="button">Cancel</button>
        <button id="cropSubmit" class="btn btn-primary" type="button">
          <i class="fas fa-check"></i>
          Save Crop
        </button>
      </div>
    </div>
  </div>

  <div class="page-footer">
    Â© 2025 Romblon State University | RFID Registration System
  </div>

  <script src="../src/js/rfid_registration.js"></script>
  <script>
    // College and course data
    const collegeData = {
      "College of Arts and Sciences": [
        "Bachelor of Science in Biology major in Microbiology",
        "Bachelor of Arts in English Language", 
        "Bachelor of Arts in Political Science",
        "Bachelor of Arts in Public Administration"
      ],
      "College of Business and Accountancy": [
        "Bachelor of Science in Accountancy",
        "Bachelor of Science in Business Administration - Major in Operations Management",
        "Bachelor of Science in Business Administration - Major in Financial Management", 
        "Bachelor of Science in Hospitality Management"
      ],
      "College of Education": [
        "Bachelor in Elementary Education",
        "Bachelor in Secondary Education - Major in General Science",
        "Bachelor in Secondary Education - Major in English",
        "Bachelor in Secondary Education - Major in Mathematics",
        "Bachelor in Secondary Education - Major in Filipino", 
        "Bachelor in Physical Education",
        "Bachelor in Technology and Livelihood Education"
      ],
      "College of Engineering and Technology": [
        "Bachelor of Science in Agricultural and Bio-systems Engineering",
        "Bachelor of Science in Civil Engineering",
        "Bachelor of Science in Electrical Engineering",
        "Bachelor of Science in Mechanical Engineering"
      ],
      "College of Computing, Multimedia Arts, and Digital Innovation": [
        "Bachelor of Science in Information Technology",
        "Bachelor of Science in Multimedia Arts"
      ]
    };

    // Initialize enhanced form elements
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatePicker();
      initializeInputMasks();
      initializeValidation();
      toggleDepartmentField(); // Set initial state
      attachDepartmentSaver(); // Attach saver to department field
    });

    // Date picker initialization
    function initializeDatePicker() {
      flatpickr("#birthdate", {
        dateFormat: "F j, Y",
        maxDate: "today",
        minDate: new Date().setFullYear(new Date().getFullYear() - 100),
        onChange: function(selectedDates, dateStr, instance) {
          validateBirthdate(dateStr);
        }
      });
    }

    // Input masks
    function initializeInputMasks() {
      // Phone number mask (Philippines format)
      Inputmask({"mask": "+63 999 999 9999", "placeholder": " "}).mask("#contactNumber");
      
      // Middle initial mask (2 characters max)
      Inputmask({"mask": "A{1,2}", "placeholder": ""}).mask("#middleInitial");
    }

    // Dynamic department/course field toggle
    function toggleDepartmentField() {
      const role = document.getElementById('role').value;
      const departmentContainer = document.getElementById('departmentContainer');
      const coursePositionContainer = document.getElementById('coursePositionContainer');
      
  if (role === 'student') {
        // Create college dropdown
        departmentContainer.innerHTML = `
          <select class="form-control" id="department" required onchange="updateCourseOptions()">
            <option value="">Select College</option>
            ${Object.keys(collegeData).map(college => 
              `<option value="${college}">${college}</option>`
            ).join('')}
          </select>
        `;
        
        // Create course dropdown
        coursePositionContainer.innerHTML = `
          <select class="form-control" id="coursePosition" required>
            <option value="">Select College First</option>
          </select>
        `;
        // After creating dynamic selects, attach saver for department select
        attachDepartmentSaver();
      } else {
        // Text fields for faculty/employee
        departmentContainer.innerHTML = `
          <input type="text" class="form-control" placeholder="College or Department" id="department" required>
        `;
        coursePositionContainer.innerHTML = `
          <input type="text" class="form-control" placeholder="Course or Position" id="coursePosition" required>
        `;
        // After creating text input, attach saver for department input
        attachDepartmentSaver();
      }
    }

    // Update course options based on selected college
    function updateCourseOptions() {
      const college = document.getElementById('department').value;
      const courseSelect = document.getElementById('coursePosition');
      
      if (college && collegeData[college]) {
        courseSelect.innerHTML = `
          <option value="">Select Course</option>
          ${collegeData[college].map(course => 
            `<option value="${course}">${course}</option>`
          ).join('')}
        `;
        // persist selected college/department for ID preview
        try { localStorage.setItem('selectedDepartment', college); } catch (e) { /* ignore storage errors */ }
      } else {
        courseSelect.innerHTML = '<option value="">Select College First</option>';
        try { localStorage.removeItem('selectedDepartment'); } catch (e) { /* ignore */ }
      }
    }

    // Attach change/input listener to current #department field (works for select or input)
    function attachDepartmentSaver() {
      const deptField = document.getElementById('department');
      if (!deptField) return;

      // remove previous handlers by cloning
      const newField = deptField.cloneNode(true);
      deptField.parentNode.replaceChild(newField, deptField);

      newField.addEventListener('change', function() {
        const val = this.value || '';
        try { localStorage.setItem('selectedDepartment', val); } catch (e) {}
        // If it's a select, also update course options
        if (this.tagName.toLowerCase() === 'select') {
          updateCourseOptions();
        }
      });

      // also save on input for text inputs
      newField.addEventListener('input', function() {
        const val = this.value || '';
        try { localStorage.setItem('selectedDepartment', val); } catch (e) {}
      });
    }

    // Real-time validation
    function initializeValidation() {
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('blur', function() {
          validateField(this);
        });
        
        input.addEventListener('input', function() {
          clearValidation(this);
        });
      });
    }

    // Field validation
    function validateField(field) {
      const value = field.value.trim();
      const fieldId = field.id;
      
      switch(fieldId) {
        case 'firstName':
        case 'lastName':
          if (!value) {
            showValidation(field, 'This field is required');
          } else if (!/^[A-Za-z\s]+$/.test(value)) {
            showValidation(field, 'Only letters and spaces allowed');
          } else {
            showValidation(field, '', true);
          }
          break;
          
        case 'contactNumber':
          if (!value) {
            showValidation(field, 'Contact number is required');
          } else if (!/^\+63\s\d{3}\s\d{3}\s\d{4}$/.test(value)) {
            showValidation(field, 'Please enter a valid Philippine number (+63 XXX XXX XXXX)');
          } else {
            showValidation(field, '', true);
          }
          break;
          
        case 'birthdate':
          validateBirthdate(value);
          break;
          
        case 'height':
          if (value && (value < 100 || value > 250)) {
            showValidation(field, 'Please enter a valid height (100-250 cm)');
          } else {
            showValidation(field, '', true);
          }
          break;
          
        case 'weight':
          if (value && (value < 30 || value > 200)) {
            showValidation(field, 'Please enter a valid weight (30-200 kg)');
          } else {
            showValidation(field, '', true);
          }
          break;
          
        default:
          if (field.required && !value) {
            showValidation(field, 'This field is required');
          } else {
            showValidation(field, '', true);
          }
      }
    }

    // Birthdate validation with age calculation
    function validateBirthdate(dateStr) {
      const field = document.getElementById('birthdate');
      if (!dateStr) {
        showValidation(field, 'Birthdate is required');
        return;
      }
      
      const birthDate = new Date(dateStr);
      const today = new Date();
      const age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      
      const actualAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate()) ? age - 1 : age;
      
      if (actualAge < 16) {
        showValidation(field, 'Must be at least 16 years old');
      } else if (actualAge > 100) {
        showValidation(field, 'Please enter a valid birthdate');
      } else {
        showValidation(field, '', true);
      }
    }

    // Show validation message
    function showValidation(field, message, isValid = false) {
      const fieldId = field.id;
      const validationElement = document.getElementById(fieldId + 'Validation');
      
      if (validationElement) {
        validationElement.textContent = message;
        validationElement.className = 'validation-message ' + (isValid ? 'valid' : 'error');
      }
      
      field.classList.toggle('missing', !isValid && message);
      field.classList.toggle('valid', isValid);
    }

    // Clear validation
    function clearValidation(field) {
      const fieldId = field.id;
      const validationElement = document.getElementById(fieldId + 'Validation');
      
      if (validationElement) {
        validationElement.textContent = '';
        validationElement.className = 'validation-message';
      }
      
      field.classList.remove('missing', 'valid');
    }

    // Add CSS for validation messages
    const style = document.createElement('style');
    style.textContent = `
      .validation-message {
        font-size: 0.8rem;
        margin-top: 4px;
        min-height: 16px;
      }
      .validation-message.error {
        color: var(--error);
      }
      .validation-message.valid {
        color: var(--success);
      }
      input.missing, select.missing {
        border-color: var(--error) !important;
        background-color: rgba(220, 38, 38, 0.05);
      }
      input.valid, select.valid {
        border-color: var(--success) !important;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>